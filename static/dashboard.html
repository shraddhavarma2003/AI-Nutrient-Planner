<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - AI Nutrition Planner</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #10b981;
            --primary-soft: #ecfdf5;
            --primary-dark: #065f46;
            --secondary: #3b82f6;
            --secondary-soft: #eff6ff;
            --accent: #6366f1;
            --bg: #f8fafc;
            --sidebar: #ffffff;
            --card: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #f1f5f9;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.02);
            --shadow-md: 0 4px 20px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.03);
            --radius-sm: 8px;
            --radius-md: 16px;
            --radius-lg: 24px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            overflow: hidden;
        }

        #bg-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
            opacity: 0.6;
        }

        /* Layout Structure */
        .app-shell {
            display: flex;
            width: 100%;
            height: 100vh;
            position: relative;
            z-index: 1;
        }

        /* Fixed Sidebar */
        .sidebar {
            width: 260px;
            background: var(--sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 32px 20px;
            transition: var(--transition);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 0 12px 32px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .logo h1 {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .logo span {
            color: var(--primary);
        }

        .nav-sections {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: var(--radius-sm);
            text-decoration: none;
            color: var(--text-muted);
            font-weight: 500;
            font-size: 14px;
            transition: var(--transition);
            cursor: pointer;
        }

        .nav-item:hover,
        .nav-item.active {
            background: var(--primary-soft);
            color: var(--primary-dark);
        }

        .nav-item i {
            font-size: 18px;
        }

        /* Main Content Container */
        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            position: relative;
        }

        /* Nav Tabs */
        .nav-tabs {
            display: none;
            /* Hidden by default, shown when mode active */
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .tab-btn {
            padding: 12px;
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Meal Plan Grid */
        .meal-plan-container {
            display: none;
            /* Shown via JS */
        }

        .meal-plan-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .day-column {
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .day-header {
            font-weight: 700;
            font-size: 14px;
            color: var(--primary);
            border-bottom: 1px solid var(--border);
            padding-bottom: 8px;
            margin-bottom: 4px;
        }

        .meal-slot {
            padding: 10px;
            background: var(--bg);
            border-radius: var(--radius-sm);
            font-size: 13px;
        }

        .meal-slot-title {
            font-weight: 700;
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .meal-slot-name {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .meal-slot-cals {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* Grocery Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            width: 90%;
            max-width: 500px;
            border-radius: var(--radius-md);
            padding: 32px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .grocery-cat {
            margin-bottom: 20px;
        }

        .grocery-cat-title {
            font-weight: 700;
            font-size: 15px;
            margin-bottom: 10px;
            color: var(--secondary);
        }

        .grocery-list-items {
            display: grid;
            gap: 8px;
        }

        .grocery-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        /* Prediction Card Enhancements */
        .prediction-box {
            display: flex;
            gap: 16px;
            margin-top: 16px;
        }

        .pred-metric {
            flex: 1;
            padding: 12px;
            background: var(--bg);
            border-radius: var(--radius-sm);
            text-align: center;
        }

        .pred-val {
            font-size: 18px;
            font-weight: 700;
            color: var(--accent);
        }

        .pred-lbl {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            font-weight: 600;
        }

        /* Sticky Header */
        .top-bar {
            position: sticky;
            top: 0;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            padding: 16px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            border-bottom: 1px solid var(--border);
        }

        .search-area {
            position: relative;
            width: 100%;
            max-width: 400px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .action-btn {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
            transition: var(--transition);
        }

        .action-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-2px);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 4px;
            padding-right: 16px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 100px;
            transition: var(--transition);
            cursor: pointer;
        }

        .user-profile:hover {
            box-shadow: var(--shadow-md);
        }

        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
        }

        .user-info .name {
            font-size: 14px;
            font-weight: 600;
        }

        /* Dashboard Content Grid */
        .content-body {
            padding: 40px;
            max-width: 1600px;
            width: 100%;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 360px;
            gap: 32px;
        }

        @media (max-width: 1200px) {
            .content-body {
                grid-template-columns: 1fr;
            }
        }

        .section-header {
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-main);
        }

        .section-desc {
            font-size: 14px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Cards and Components */
        .card {
            background: var(--card);
            border-radius: var(--radius-md);
            padding: 24px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
        }

        /* Health Overview Group */
        .health-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .vital-card {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .vital-icon-box {
            width: 48px;
            height: 48px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-bottom: 8px;
        }

        .vital-item .label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .vital-item .value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-main);
            margin: 4px 0;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 100px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .status-badge.safe {
            background: var(--primary-soft);
            color: var(--primary-dark);
        }

        .status-badge.warning {
            background: #fff7ed;
            color: #9a3412;
        }

        .status-badge.danger {
            background: #fef2f2;
            color: #991b1b;
        }

        .status-badge.pending {
            background: #f8fafc;
            color: #64748b;
        }

        .tag {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            margin: 4px;
            background: #f1f5f9;
            color: #475569;
        }

        .tag.condition {
            background: #fee2e2;
            color: #b91c1c;
        }

        .tag.allergy {
            background: #fff7ed;
            color: #c2410c;
        }

        /* Nutrition Overview */
        .nutrition-card {
            margin-bottom: 32px;
        }

        .nutrition-header {
            display: flex;
            align-items: center;
            gap: 32px;
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border);
        }

        .calorie-ring-container {
            position: relative;
            width: 120px;
            height: 120px;
        }

        .calorie-ring-container svg {
            transform: rotate(-90deg);
        }

        .calorie-ring-bg {
            fill: none;
            stroke: #f1f5f9;
            stroke-width: 10;
        }

        .calorie-ring-fill {
            fill: none;
            stroke: var(--primary);
            stroke-width: 10;
            stroke-linecap: round;
            transition: stroke-dasharray 1s ease;
        }

        .calorie-label-box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .calorie-label-box .val {
            font-size: 22px;
            font-weight: 800;
        }

        .calorie-label-box .unit {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .nutrition-meta h3 {
            font-size: 20px;
            font-weight: 700;
        }

        .nutrition-meta p {
            color: var(--text-muted);
            font-size: 14px;
        }

        .macros-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
        }

        .macro-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .macro-info {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
        }

        .macro-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-muted);
        }

        .macro-val {
            font-size: 14px;
            font-weight: 700;
        }

        .progress-track {
            height: 10px;
            background: #f1f5f9;
            border-radius: 100px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 100px;
            transition: width 1s ease;
        }

        .progress-fill.protein {
            background: #10b981;
        }

        .progress-fill.carbs {
            background: #3b82f6;
        }

        .progress-fill.fat {
            background: #f59e0b;
        }

        /* Action Cards Group */
        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .action-card {
            background: white;
            padding: 24px;
            cursor: pointer;
            text-align: left;
        }

        .action-card .icon {
            font-size: 28px;
            margin-bottom: 16px;
            display: block;
        }

        .action-card h3 {
            font-size: 16px;
            margin-bottom: 8px;
        }

        .action-card p {
            font-size: 13px;
            color: var(--text-muted);
            line-height: 1.5;
            margin-bottom: 16px;
        }

        .btn-link {
            font-size: 13px;
            font-weight: 600;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* AI Assistant - Floating Chat Style */
        .ai-chat-box {
            margin-top: 32px;
            background: linear-gradient(135deg, #ffffff, #f0f9ff);
        }

        #aiAgentMessages {
            height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chat-msg {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 14px;
            line-height: 1.5;
        }

        .chat-msg.ai {
            align-self: flex-start;
            background: white;
            border: 1px solid var(--border);
            border-bottom-left-radius: 4px;
            box-shadow: var(--shadow-sm);
        }

        .chat-msg.user {
            align-self: flex-end;
            background: var(--accent);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .chat-input-wrapper {
            display: flex;
            gap: 8px;
            background: white;
            padding: 8px;
            border-radius: 100px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
        }

        .chat-input-wrapper input {
            flex: 1;
            border: none;
            padding: 8px 16px;
            outline: none;
            font-size: 14px;
            font-family: inherit;
        }

        .chat-send-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .chat-send-btn:hover {
            transform: scale(1.1);
        }

        /* Sidebar - Tracking Group */
        .tracking-sidebar {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .water-card {
            background: linear-gradient(200deg, #e0f2fe, #f0f9ff);
            border: 1px solid #bae6fd;
            text-align: center;
        }

        .water-progress-wave {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(14, 165, 233, 0.1);
            transition: height 1s ease;
            z-index: 1;
        }

        .water-content {
            position: relative;
            z-index: 2;
        }

        .water-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .water-title {
            font-weight: 700;
            color: #0369a1;
        }

        .water-circle-display {
            margin: 20px auto;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 4px solid #bae6fd;
            box-shadow: var(--shadow-md);
        }

        .water-count {
            font-size: 24px;
            font-weight: 800;
            color: #0369a1;
        }

        .water-label {
            font-size: 10px;
            color: #64748b;
            font-weight: 700;
        }

        .water-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
        }

        .water-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            border: none;
            background: white;
            color: #0ea5e9;
            font-size: 20px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
        }

        .water-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* Recent Meals styling */
        .meal-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .meal-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 12px;
            transition: var(--transition);
        }

        .meal-item:hover {
            background: white;
            box-shadow: var(--shadow-sm);
        }

        .meal-icon {
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .meal-txt {
            flex: 1;
        }

        .meal-name {
            font-size: 14px;
            font-weight: 600;
        }

        .meal-cal {
            font-size: 12px;
            color: var(--text-muted);
        }

        .meal-time {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* Date Picker UI */
        .date-bar {
            background: white;
            padding: 12px 24px;
            border-radius: 100px;
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 32px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
        }

        .date-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f1f5f9;
            padding: 4px;
            border-radius: 100px;
        }

        .nav-date-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: transparent;
            cursor: pointer;
            color: var(--text-muted);
            transition: var(--transition);
        }

        .nav-date-btn:hover {
            background: white;
            color: var(--primary);
        }

        .date-input {
            border: none;
            background: transparent;
            font-weight: 600;
            font-family: inherit;
            font-size: 14px;
            color: var(--text-main);
            outline: none;
        }

        .today-chip {
            padding: 6px 16px;
            background: var(--primary);
            color: white;
            border-radius: 100px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        /* Custom Toggle */
        .switch-box {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.5);
            padding: 4px 12px;
            border-radius: 100px;
        }

        .switch-lbl {
            font-size: 10px;
            font-weight: 700;
            color: #0369a1;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 36px;
            height: 20px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #0ea5e9;
        }

        input:checked+.slider:before {
            transform: translateX(16px);
        }

        /* ml forecast spacing */
        .ml-forecast-card {
            background: white;
            border-left: 4px solid var(--primary);
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #e2e8f0;
            border-radius: 100px;
        }
    </style>
</head>

<body>
    <canvas id="bg-canvas"></canvas>

    <div class="app-shell">
        <!-- Minimal Sidebar -->
        <nav class="sidebar">
            <div class="logo" onclick="location.href='index.html'">
                <div class="logo-icon">ü•ó</div>
                <h1>Nutrition<span>AI</span></h1>
            </div>
            <div class="nav-sections">
                <a class="nav-item active" id="navDashboard" onclick="switchTab('dashboard')"><i>üìä</i> Dashboard</a>
                <a class="nav-item" id="navPlan" onclick="switchTab('meal-plan')"><i>üìÖ</i> Weekly Plan</a>
                <a class="nav-item" id="navScan" onclick="location.href='food-scan.html'"><i>üì∏</i> Food Scan</a>
                <a class="nav-item" id="navReport" onclick="location.href='upload.html'"><i>üìÑ</i> Reports</a>
                <a class="nav-item" id="navRecipe" onclick="location.href='app.html?mode=recipe'"><i>üç≥</i> Recipes</a>
                <a class="nav-item" id="navCoach" onclick="location.href='index.html'"><i>üí¨</i> Coach Chat</a>
            </div>
            <div class="sidebar-user" onclick="handleLogout()" style="margin-top: auto;">
                <div class="avatar" id="avatarIcon">U</div>
                <div class="user-info">
                    <div class="name" id="userNameSide">User</div>
                </div>
            </div>
        </nav>

        <div class="main-container">
            <!-- Sleek Top Header -->
            <header class="top-bar">
                <div class="search-area">
                    <div class="section-title">Health Dashboard</div>
                </div>

                <div class="header-actions">
                    <button class="action-btn" title="View Notifications">üîî</button>
                    <div class="user-profile" onclick="handleLogout()">
                        <div class="avatar" id="userAvatar">U</div>
                        <div class="user-info">
                            <div class="name" id="userName">User</div>
                        </div>
                    </div>
                </div>
            </header>

            <main class="content-body">
                <div class="main-scroll-content">

                    <!-- Health Overview Group -->
                    <div class="section-header">
                        <div>
                            <h2 class="section-title">Health Overview</h2>
                            <p class="section-desc">Vital signs and medical profile summary</p>
                        </div>
                    </div>

                    <div class="health-grid">
                        <!-- Medical Vitals -->
                        <div class="card vital-card" style="background: linear-gradient(135deg, #f0fdf4, #ffffff);">
                            <div class="vital-icon-box" style="background: #dcfce7; color: #166534;">ü©∫</div>
                            <div class="vital-item">
                                <p class="label">Medical Vitals</p>
                                <div class="vital-badge-container">
                                    <span class="status-badge safe" id="vitalGlucose">Glucose: --</span>
                                    <span class="status-badge safe" id="vitalCholesterol">Cholesterol: --</span>
                                </div>
                                <p class="section-desc" style="font-size: 11px; margin-top: 8px;">From your latest
                                    report</p>
                            </div>
                        </div>

                        <!-- Biometrics -->
                        <div class="card vital-card">
                            <div class="vital-icon-box" style="background: #eff6ff; color: #1e40af;">üë§</div>
                            <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                                <div class="vital-item">
                                    <p class="label" id="bmiStatus">BMI (Normal)</p>
                                    <div class="value" id="bmiValue">--</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: 700;" id="weightValue">-- kg</div>
                                    <div style="font-size: 12px; color: var(--text-muted);" id="heightValue">-- cm</div>
                                </div>
                            </div>
                        </div>

                        <!-- Conditions & Allergies -->
                        <div class="card">
                            <p class="label"
                                style="font-size: 10px; font-weight: 700; color: var(--text-muted); text-transform: uppercase;">
                                Medical Tags</p>
                            <div style="margin-top: 12px;">
                                <div id="conditionsTags"><span class="tag">Loading...</span></div>
                                <div id="allergiesTags" style="margin-top: 4px;"><span class="tag">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Nutrition Overview Group -->
                    <div class="section-header">
                        <div>
                            <h2 class="section-title">Daily Nutrition</h2>
                            <p class="section-desc">Track your calorie and macro intake</p>
                        </div>
                    </div>

                    <div class="card nutrition-card">
                        <div class="nutrition-header">
                            <div class="calorie-ring-container">
                                <svg width="120" height="120">
                                    <circle class="calorie-ring-bg" cx="60" cy="60" r="52"></circle>
                                    <circle class="calorie-ring-fill" cx="60" cy="60" r="52" stroke-dasharray="0 999"
                                        id="calorieRing"></circle>
                                </svg>
                                <div class="calorie-label-box">
                                    <div class="val" id="calorieValue">--</div>
                                    <div class="unit">kcal</div>
                                </div>
                            </div>
                            <div class="nutrition-meta">
                                <h3 id="nutritionStatus">Awaiting Log</h3>
                                <p id="nutritionMessage">Complete your first log to see your progress.</p>
                                <div class="ai-note" id="aiNote"
                                    style="display: none; margin-top: 12px; background: #fff7ed; border-color: #ffedd5; padding: 10px;">
                                    <span style="font-size: 16px;">üí°</span>
                                    <p id="aiNoteText" style="color: #9a3412; font-size: 13px; font-weight: 500;"></p>
                                </div>
                            </div>
                        </div>

                        <div class="macros-grid">
                            <div class="macro-item">
                                <div class="macro-info">
                                    <span class="macro-name">Protein</span>
                                    <span class="macro-val" id="proteinValue">-- / --g</span>
                                </div>
                                <div class="progress-track">
                                    <div class="progress-fill protein" id="proteinBar" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="macro-item">
                                <div class="macro-info">
                                    <span class="macro-name">Carbs</span>
                                    <span class="macro-val" id="carbsValue">-- / --g</span>
                                </div>
                                <div class="progress-track">
                                    <div class="progress-fill carbs" id="carbsBar" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="macro-item">
                                <div class="macro-info">
                                    <span class="macro-name">Fats</span>
                                    <span class="macro-val" id="fatValue">-- / --g</span>
                                </div>
                                <div class="progress-track">
                                    <div class="progress-fill fat" id="fatBar" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Date Selection Bar -->
                    <div class="date-bar">
                        <span class="date-label">Timeline</span>
                        <div class="date-controls">
                            <button class="nav-date-btn" onclick="adjustDate(-1)">‚óÄ</button>
                            <input type="date" id="dashboardDatePicker" class="date-input"
                                onchange="handleDateChange()">
                            <button class="nav-date-btn" onclick="adjustDate(1)">‚ñ∂</button>
                        </div>
                        <div class="today-chip" onclick="goToToday()">Return to Today</div>
                        <div style="flex: 1; text-align: right; font-size: 13px; font-weight: 700; color: var(--primary);"
                            id="snapshotTitle">Today</div>
                    </div>

                    <!-- AI Insights / Weight Forecast -->
                    <div class="section-header">
                        <div>
                            <h2 class="section-title">Predictive Insights</h2>
                            <p class="section-desc">ML-powered forecasts based on your trends</p>
                        </div>
                    </div>

                    <div class="card ml-forecast-card" style="margin-bottom: 32px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 24px;">
                            <div style="flex: 1;">
                                <p class="label" style="font-size: 11px; margin-bottom: 4px;">Predictive Insights</p>
                                <div class="prediction-box">
                                    <div class="pred-metric">
                                        <div class="pred-lbl">Next Meal</div>
                                        <div class="pred-val" id="predNextMeal">--</div>
                                        <div style="font-size: 11px; color: var(--text-muted);" id="predNextTime">--
                                        </div>
                                    </div>
                                    <div class="pred-metric">
                                        <div class="pred-lbl">Calorie Buffer</div>
                                        <div class="pred-val" id="predBuffer">-- kcal</div>
                                        <div style="font-size: 11px; color: var(--text-muted);" id="predBufferStatus">--
                                        </div>
                                    </div>
                                    <div class="pred-metric">
                                        <div class="pred-lbl">Weight 30d</div>
                                        <div class="pred-val" id="predWeight">-- kg</div>
                                        <div style="font-size: 11px; color: var(--text-muted);" id="predWeightTrend">--
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                    <!-- Actions Group -->
                    <div class="section-header">
                        <div>
                            <h2 class="section-title">Quick Actions</h2>
                            <p class="section-desc">Access core features instantly</p>
                        </div>
                    </div>

                    <div class="actions-grid">
                        <div class="card action-card" onclick="location.href='food-scan.html'">
                            <span class="icon">üì∏</span>
                            <h3>Scan Food</h3>
                            <p>Capture a photo of your meal for instant nutrient analysis.</p>
                            <span class="btn-link">Analyze Scan ‚Üí</span>
                        </div>
                        <div class="card action-card" onclick="location.href='upload.html'">
                            <span class="icon">üìÑ</span>
                            <h3>Sync Report</h3>
                            <p>Upload medical reports to personalize your health profile.</p>
                            <span class="btn-link">Upload Report ‚Üí</span>
                        </div>
                        <div class="card action-card" onclick="location.href='app.html?mode=recipe'">
                            <span class="icon">üç≤</span>
                            <h3>Chef AI</h3>
                            <p>Get personalized recipe recommendations based on your logs.</p>
                            <span class="btn-link">Generate ‚Üí</span>
                        </div>
                        <div class="card action-card" onclick="location.href='app.html?mode=analyze'">
                            <span class="icon">üìä</span>
                            <h3>Nutrition Analysis</h3>
                            <p>Deep dive into your nutritional trends and statistics.</p>
                            <span class="btn-link">View Stats ‚Üí</span>
                        </div>
                    </div>

                    <!-- AI Chat Box -->
                    <div class="card ai-chat-box">
                        <div class="section-header" style="margin-bottom: 12px;">
                            <h2 class="section-title" style="font-size: 16px;">ü§ñ AI Health Coordinator</h2>
                        </div>
                        <div id="aiAgentMessages">
                            <div class="chat-msg ai"> I'm your health coordinator! I can check your nutrition stats,
                                suggest meal fixes, generate recipes, or give exercise advice. How can I help you today?
                            </div>
                        </div>
                        <div class="chat-input-wrapper">
                            <input type="text" id="aiAgentInput" placeholder="Ask anything about your health..."
                                onkeypress="if(event.key==='Enter') sendAgentMessage()">
                            <button class="chat-send-btn" id="sendAgentBtn" onclick="sendAgentMessage()">üöÄ</button>
                        </div>
                    </div>
                </div>

                <!-- Meal Plan Section (Hidden by default) -->
                <div id="mealPlanSection" class="meal-plan-container">
                    <div class="section-header">
                        <div>
                            <h2 class="section-title">Weekly Meal Plan</h2>
                            <p class="section-desc" id="planDates">Your personalized 7-day nutritional map</p>
                        </div>
                        <div style="display: flex; gap: 12px;">
                            <button class="btn-link" onclick="showGroceryList()"
                                style="background: var(--secondary-soft); padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer;">üìù
                                View Groceries</button>
                            <button class="btn-link" onclick="generateNewPlan()"
                                style="background: var(--primary-soft); padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer;">‚ú®
                                Regenerate Plan</button>
                        </div>
                    </div>
                    <div class="meal-plan-grid" id="mealPlanGrid">
                        <!-- Injected via JS -->
                        <div style="padding: 40px; text-align: center; width: 100%; grid-column: 1/-1;">
                            <p>Loading your meal plan...</p>
                        </div>
                    </div>
                </div>

                <!-- Tracking Sidebar (Right) -->
                <aside class="tracking-sidebar">
                    <!-- Water Tracker -->
                    <div class="card water-card">
                        <div class="water-progress-wave" id="waterProgress" style="height: 0%"></div>
                        <div class="water-content">
                            <div class="water-header">
                                <span class="water-title">Hydration</span>
                                <div class="switch-box">
                                    <span class="switch-lbl">Reminders</span>
                                    <label class="switch">
                                        <input type="checkbox" id="waterReminderToggle"
                                            onchange="toggleWaterReminders()">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>

                            <div class="water-circle-display">
                                <div class="water-count" id="waterCount">0</div>
                                <div class="water-label">CUPS</div>
                            </div>

                            <p id="waterLiters"
                                style="font-size: 12px; font-weight: 700; color: #0ea5e9; margin-bottom: 20px;">0.0L
                                TODAY</p>

                            <div class="water-controls">
                                <button class="water-btn" onclick="updateWater(-1)">‚àí</button>
                                <div style="text-align: center;">
                                    <div id="waterRemaining" style="font-size: 11px; font-weight: 700; color: #64748b;">
                                        Goal: 8 Cups</div>
                                    <div id="reminderStatus" class="notification-status"
                                        style="font-size: 9px; color: var(--primary); font-weight: 800; margin-top: 4px;">
                                        ACTIVE üîî</div>
                                </div>
                                <button class="water-btn" onclick="updateWater(1)">+</button>
                            </div>
                        </div>
                    </div>

                    <!-- Daily Stats -->
                    <div class="card">
                        <h4 style="font-size: 15px; font-weight: 700; margin-bottom: 16px;">Daily Statistics</h4>
                        <div class="meal-list" id="statsContent">
                            <div
                                style="display: flex; justify-content: space-between; padding-bottom: 8px; border-bottom: 1px solid var(--border);">
                                <span style="font-size: 13px; color: var(--text-muted);">Meals Logged</span>
                                <span style="font-weight: 700;" id="mealsCount">--</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding-top: 8px;">
                                <span style="font-size: 13px; color: var(--text-muted);">Activity</span>
                                <span style="font-weight: 700; color: var(--accent);">Syncing Fit</span>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Meals -->
                    <div class="card">
                        <h4 style="font-size: 15px; font-weight: 700; margin-bottom: 16px;">Recent Meals</h4>
                        <div class="meal-list" id="recentMealsContent">
                            <div class="empty-state">No recent activity</div>
                        </div>
                    </div>

                    <!-- Tip of the Day -->
                    <div class="card" style="background: var(--primary-dark); color: white;">
                        <h4 style="font-size: 14px; margin-bottom: 8px;">üí° Pro Tip</h4>
                        <p style="font-size: 12px; opacity: 0.9; line-height: 1.6;">Logging your meals within 30 minutes
                            of eating improved accuracy by 40%.</p>
                    </div>
                </aside>
            </main>
        </div>

        <!-- Grocery List Modal -->
        <div id="groceryModal" class="modal">
            <div class="modal-content">
                <div class="section-header" style="margin-bottom: 24px;">
                    <h2 class="section-title">Grocery List</h2>
                    <button onclick="closeModal('groceryModal')"
                        style="border: none; background: transparent; font-size: 20px; cursor: pointer;">‚úï</button>
                </div>
                <div id="groceryListContent">
                    <p>Loading list...</p>
                </div>
                <button onclick="closeModal('groceryModal')"
                    style="width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; margin-top: 24px; cursor: pointer; font-weight: 700;">Done</button>
            </div>
        </div>
    </div>

    <script>
        // Core Logic
        const token = localStorage.getItem('token');
        let userProfile = null;
        const now = new Date();
        let selectedDate = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;

        if (!token) window.location.href = 'login.html';

        const userName = localStorage.getItem('user_name') || 'User';
        const userInitial = userName.charAt(0).toUpperCase();
        if (document.getElementById('userName')) document.getElementById('userName').textContent = userName;
        if (document.getElementById('userAvatar')) document.getElementById('userAvatar').textContent = userInitial;
        if (document.getElementById('userNameSide')) document.getElementById('userNameSide').textContent = userName;
        if (document.getElementById('avatarIcon')) document.getElementById('avatarIcon').textContent = userInitial;

        async function handleLogout() {
            try {
                await fetch('/auth/logout', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
            } catch (err) { console.log('Logout failed'); }
            localStorage.clear();
            window.location.href = 'login.html';
        }

        async function loadProfile() {
            try {
                const response = await fetch('/api/profile', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.status === 401) { window.location.href = 'login.html'; return; }
                if (!response.ok) { window.location.href = 'setup-profile.html'; return; }
                const data = await response.json();
                userProfile = data;
                const name = data.full_name || userName;
                const initial = name.charAt(0).toUpperCase();
                if (document.getElementById('userNameSide')) document.getElementById('userNameSide').textContent = name;
                if (document.getElementById('avatarIcon')) document.getElementById('avatarIcon').textContent = initial;
                if (document.getElementById('userName')) document.getElementById('userName').textContent = name;
                if (document.getElementById('userAvatar')) document.getElementById('userAvatar').textContent = initial;
                updateProfileUI(data);
                document.getElementById('dashboardDatePicker').value = selectedDate;
                loadDashboardData();
                loadWeightForecast();
            } catch (err) { console.error('Profile error:', err); }
        }

        async function loadTodayMeals() {
            try {
                const response = await fetch(`/api/meals/today?date=${selectedDate}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                const meals = data.meals || [];
                updateNutritionUI(meals);
                updateMealsUI(meals);
            } catch (err) { console.error('Meals error:', err); }
        }

        async function loadDashboardData() {
            const isTodayString = new Date().toISOString().split('T')[0];
            const isToday = selectedDate === isTodayString;
            document.getElementById('snapshotTitle').textContent = isToday ? "Today" : formatDisplayDate(selectedDate);

            // Use Promise.all to avoid race conditions and ensure UI updates are consistent
            try {
                const [stats, meals] = await Promise.all([
                    fetch(`/api/daily-stats?date=${selectedDate}`, { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json()),
                    fetch(`/api/meals/today?date=${selectedDate}`, { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json())
                ]);

                // Update UI in specific order
                const mealsList = meals.meals || [];
                updateNutritionUI(mealsList); // Sets mealsCount
                updateStatsTable(stats, mealsList.length); // NEW: specific stats update
                updateDailyStatsUI(stats); // Updates ring and macros
                updateMealsUI(mealsList);
            } catch (err) {
                console.error('Dashboard data error:', err);
            }
        }

        function formatDisplayDate(dateStr) {
            const options = { weekday: 'short', month: 'short', day: 'numeric' };
            return new Date(dateStr).toLocaleDateString(undefined, options);
        }

        function handleDateChange() {
            selectedDate = document.getElementById('dashboardDatePicker').value;
            loadDashboardData();
        }

        function adjustDate(days) {
            const date = new Date(selectedDate);
            date.setDate(date.getDate() + days);
            selectedDate = date.toISOString().split('T')[0];
            document.getElementById('dashboardDatePicker').value = selectedDate;
            loadDashboardData();
        }

        function goToToday() {
            const d = new Date();
            selectedDate = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
            document.getElementById('dashboardDatePicker').value = selectedDate;
            loadDashboardData();
        }

        async function loadDailyStats() {
            try {
                const response = await fetch(`/api/daily-stats?date=${selectedDate}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const stats = await response.json();
                    updateDailyStatsUI(stats);
                }
            } catch (err) { console.error('Stats error:', err); }
        }

        function updateProfileUI(profile) {
            if (!profile) return;

            if (profile.bio_metrics) {
                const bm = profile.bio_metrics;
                const bmiVal = document.getElementById('bmiValue');
                const bmiSt = document.getElementById('bmiStatus');
                const weightVal = document.getElementById('weightValue');
                const heightVal = document.getElementById('heightValue');

                if (bm.bmi || (bm.weight_kg && bm.height_cm)) {
                    const bmi = bm.bmi || (bm.weight_kg / (Math.pow(bm.height_cm / 100, 2))).toFixed(1);
                    if (bmiVal) bmiVal.textContent = isFinite(bmi) ? bmi : '--';

                    let s = 'Normal';
                    if (bmi < 18.5) s = 'Underweight';
                    else if (bmi >= 25 && bmi < 30) s = 'Overweight';
                    else if (bmi >= 30) s = 'Obese';
                    if (bmiSt) bmiSt.textContent = `BMI (${s})`;
                }
                if (bm.weight_kg && weightVal) weightVal.textContent = `${bm.weight_kg} kg`;
                if (bm.height_cm && heightVal) heightVal.textContent = `${bm.height_cm} cm`;
            }

            const condTags = document.getElementById('conditionsTags');
            const allergicTags = document.getElementById('allergiesTags');

            if (condTags) {
                condTags.innerHTML = (profile.conditions && profile.conditions.length > 0) ?
                    profile.conditions.map(c => `<span class="tag condition">${c}</span>`).join('') : '<span class="tag">No Conditions</span>';
            }
            if (allergicTags) {
                allergicTags.innerHTML = (profile.allergies && profile.allergies.length > 0) ?
                    profile.allergies.map(a => `<span class="tag allergy">${a}</span>`).join('') : '<span class="tag">No Allergies</span>';
            }

            if (profile.vitals) {
                const glucoseEl = document.getElementById('vitalGlucose');
                const cholesterolEl = document.getElementById('vitalCholesterol');
                if (glucoseEl && profile.vitals.glucose_level) glucoseEl.textContent = 'Glucose: ' + profile.vitals.glucose_level;
                if (cholesterolEl && profile.vitals.cholesterol) cholesterolEl.textContent = 'Cholesterol: ' + profile.vitals.cholesterol;
            }
        }

        function updateDailyStatsUI(stats) {
            const targetCals = stats.calories_target || 2000;
            const currentCals = Math.round(stats.calories_consumed || 0);

            const calVal = document.getElementById('calorieValue');
            const calRing = document.getElementById('calorieRing');

            if (calVal) calVal.textContent = currentCals;
            if (calRing) {
                const caloriePercent = Math.min(currentCals / targetCals, 1);
                calRing.setAttribute('stroke-dasharray', `${caloriePercent * 326.7} 999`);
            }

            const tP = userProfile?.daily_targets?.protein_g || 80;
            const tC = userProfile?.daily_targets?.carbs_g || 250;
            const tF = userProfile?.daily_targets?.fat_g || 65;

            const pBar = document.getElementById('proteinBar');
            const cBar = document.getElementById('carbsBar');
            const fBar = document.getElementById('fatBar');
            const pVal = document.getElementById('proteinValue');
            const cVal = document.getElementById('carbsValue');
            const fVal = document.getElementById('fatValue');

            if (pBar) pBar.style.width = Math.min((stats.protein_g / tP) * 100, 100) + '%';
            if (cBar) cBar.style.width = Math.min((stats.carbs_g / tC) * 100, 100) + '%';
            if (fBar) fBar.style.width = Math.min((stats.fat_g / tF) * 100, 100) + '%';

            if (pVal) pVal.textContent = `${Math.round(stats.protein_g)} / ${Math.round(tP)}g`;
            if (cVal) cVal.textContent = `${Math.round(stats.carbs_g)} / ${Math.round(tC)}g`;
            if (fVal) fVal.textContent = `${Math.round(stats.fat_g)} / ${Math.round(tF)}g`;

            if (currentCals > 1800) {
                document.getElementById('aiNote').style.display = 'flex';
                document.getElementById('aiNoteText').textContent = `High intake alert: ${currentCals} kcal reached.`;
            } else {
                document.getElementById('aiNote').style.display = 'none';
            }

            refreshWaterUI(stats.water_cups);
        }

        function updateStatsTable(stats, mealsCount) {
            const statRows = document.getElementById('statsContent');
            if (statRows) {
                statRows.innerHTML = `
                    <div style="display: flex; justify-content: space-between; padding-bottom: 8px; border-bottom: 1px solid var(--border);">
                        <span style="font-size: 13px; color: var(--text-muted);">Meals Logged</span>
                        <span style="font-weight: 700;" id="mealsCount">${mealsCount}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border);">
                        <span style="font-size: 13px; color: var(--text-muted);">Burnt</span>
                        <span style="font-weight: 700;">${Math.round(stats.calories_burned || 0)} kcal</span>
                    </div>
                     <div style="display: flex; justify-content: space-between; padding-top: 8px;">
                        <span style="font-size: 13px; color: var(--text-muted);">Hydration</span>
                        <span style="font-weight: 700;">${stats.water_cups || 0} Cups</span>
                    </div>
                `;
            }
        }

        async function loadWeightForecast() {
            try {
                const response = await fetch('/api/analytics/weight-forecast', { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) return;
                const data = await response.json();
                const f = data.forecast;
                document.getElementById('forecastWeight').textContent = `${f.predicted_weight} kg`;
                document.getElementById('forecastChange').textContent = (f.weight_change >= 0 ? '+' : '') + f.weight_change + ' kg expected';
                document.getElementById('forecastStatus').textContent = f.status;
                const sEl = document.getElementById('forecastStatus');
                sEl.className = 'status-badge ' + (f.status === 'On track' ? 'safe' : (f.status === 'Stable' ? 'pending' : 'warning'));
            } catch (err) { console.error('Forecast error:', err); }
        }

        function updateNutritionUI(meals) {
            const count = meals.length;
            const countEl = document.getElementById('mealsCount');
            if (countEl) countEl.textContent = count;

            const statusEl = document.getElementById('nutritionStatus');
            const messageEl = document.getElementById('nutritionMessage');

            if (count === 0) {
                if (statusEl) statusEl.textContent = 'Awaiting Log';
                if (messageEl) messageEl.textContent = 'Scan your power meal to begin.';
            } else {
                if (statusEl) statusEl.textContent = `${count} Meal${count > 1 ? 's' : ''} Logged`;
                if (messageEl) messageEl.textContent = 'Personalized guidance active.';
            }
        }

        function updateMealsUI(meals) {
            const container = document.getElementById('recentMealsContent');
            if (meals.length === 0) {
                container.innerHTML = '<div class="empty-state">No recent activity</div>';
                return;
            }
            const recent = meals.slice(0, 3);
            container.innerHTML = recent.map(meal => `
                <div class="meal-item">
                    <div class="meal-icon">ü•ó</div>
                    <div class="meal-txt">
                        <div class="meal-name">${meal.food_name || 'Generic Food'}</div>
                        <div class="meal-cal">${Math.round(meal.nutrition?.calories || 0)} kcal</div>
                    </div>
                    <div class="meal-time">${new Date(meal.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
                </div>
            `).join('');
        }

        // Water Logic
        let waterReminderInterval = null;
        async function toggleWaterReminders() {
            const toggle = document.getElementById('waterReminderToggle');
            const status = document.getElementById('reminderStatus');
            if (toggle.checked) {
                if (!("Notification" in window)) { alert("Unsupported browser"); toggle.checked = false; return; }
                if (Notification.permission !== "granted") {
                    const p = await Notification.requestPermission();
                    if (p !== "granted") { toggle.checked = false; return; }
                }
                startWaterReminders();
                localStorage.setItem('waterRemindersEnabled', 'true');
                status.style.display = 'block';
                new Notification("Reminders Active! üíß");
            } else {
                stopWaterReminders();
                localStorage.setItem('waterRemindersEnabled', 'false');
                status.style.display = 'none';
            }
        }
        function startWaterReminders() {
            if (waterReminderInterval) clearInterval(waterReminderInterval);
            waterReminderInterval = setInterval(() => {
                if (Notification.permission === "granted") new Notification("Time to Hydrate! üíß");
            }, 3600000);
        }
        function stopWaterReminders() { if (waterReminderInterval) { clearInterval(waterReminderInterval); waterReminderInterval = null; } }
        function initWaterReminders() {
            const enabled = localStorage.getItem('waterRemindersEnabled') === 'true';
            if (enabled) {
                const t = document.getElementById('waterReminderToggle');
                if (t) {
                    t.checked = true;
                    document.getElementById('reminderStatus').style.display = 'block';
                    if (Notification.permission === "granted") startWaterReminders();
                }
            }
        }
        async function updateWater(delta) {
            try {
                const response = await fetch('/api/water/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ delta })
                });
                if (response.ok) {
                    const data = await response.json();
                    refreshWaterUI(data.water_cups);
                }
            } catch (err) { console.error('Water update error:', err); }
        }

        function refreshWaterUI(count) {
            const goal = 8;
            const liters = (count * 0.25).toFixed(1);
            const percent = Math.min((count / goal) * 100, 100);
            document.getElementById('waterCount').textContent = count;
            document.getElementById('waterLiters').textContent = `${liters}L TODAY`;
            document.getElementById('waterProgress').style.height = `${percent}%`;
            const rem = Math.max(0, goal - count);
            document.getElementById('waterRemaining').textContent = rem > 0 ? `Goal: ${rem} More` : 'Goal Reached! ‚ú®';
        }

        // AI Chat
        let agentChatHistory = [];
        async function sendAgentMessage() {
            const input = document.getElementById('aiAgentInput');
            const messagesDiv = document.getElementById('aiAgentMessages');
            const message = input.value.trim();
            if (!message) return;
            messagesDiv.innerHTML += `<div class="chat-msg user">${message}</div>`;
            input.value = '';
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            try {
                const response = await fetch('/api/coach/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ message, history: agentChatHistory })
                });
                const data = await response.json();
                let m = (data.message || "Error").replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                messagesDiv.innerHTML += `<div class="chat-msg ai"><strong>AI:</strong><br>${m}</div>`;
                agentChatHistory.push({ role: "user", content: message }, { role: "assistant", content: data.message });
                if (agentChatHistory.length > 10) agentChatHistory = agentChatHistory.slice(-10);
            } catch (error) { messagesDiv.innerHTML += `<div class="chat-msg error">Service unavailable</div>`; }
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Particle Background Logic
        function initBG() {
            const canvas = document.getElementById('bg-canvas');
            const ctx = canvas.getContext('2d');
            let w, h, ps = [];

            w = canvas.width = window.innerWidth;
            h = canvas.height = window.innerHeight;
            ps = [];
            for (let i = 0; i < 40; i++) {
                ps.push({
                    x: Math.random() * w,
                    y: Math.random() * h,
                    size: Math.random() * 2 + 1,
                    speedX: Math.random() * 0.5 - 0.25,
                    speedY: Math.random() * 0.5 - 0.25
                });
            }

            function anim() {
                ctx.clearRect(0, 0, w, h);
                ctx.fillStyle = 'rgba(16, 185, 129, 0.1)';
                ps.forEach(p => {
                    p.x += p.speedX;
                    p.y += p.speedY;
                    if (p.x < 0) p.x = w;
                    if (p.x > w) p.x = 0;
                    if (p.y < 0) p.y = h;
                    if (p.y > h) p.y = 0;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    ctx.fill();
                });
                requestAnimationFrame(anim);
            }

            window.addEventListener('resize', () => {
                w = canvas.width = window.innerWidth;
                h = canvas.height = window.innerHeight;
            });

            anim();
        }
        initBG();

        // Multi-Tab Logic
        function switchTab(tab) {
            const dashboard = document.querySelector('.main-scroll-content');
            const mealPlan = document.getElementById('mealPlanSection');
            const navDashboard = document.getElementById('navDashboard');
            const navPlan = document.getElementById('navPlan');

            if (tab === 'meal-plan') {
                dashboard.style.display = 'none';
                mealPlan.style.display = 'block';
                navDashboard.classList.remove('active');
                navPlan.classList.add('active');
                loadMealPlan();
            } else {
                dashboard.style.display = 'block';
                mealPlan.style.display = 'none';
                navDashboard.classList.add('active');
                navPlan.classList.remove('active');
            }
        }

        // Predictive Analytics Data
        async function loadPredictions() {
            try {
                const [meal, budget, trajectory] = await Promise.all([
                    fetch('/api/analytics/meal-prediction', { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json()),
                    fetch('/api/analytics/calorie-budget', { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json()),
                    fetch('/api/analytics/weight-trajectory', { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json())
                ]);

                // Update UI
                document.getElementById('predNextMeal').textContent = meal.next_meal || '--';
                document.getElementById('predNextTime').textContent = meal.estimated_time || '--';

                document.getElementById('predBuffer').textContent = `${budget.remaining_calories} kcal`;
                document.getElementById('predBufferStatus').textContent = budget.message;

                if (trajectory.current_weight) {
                    document.getElementById('predWeight').textContent = `${trajectory.predicted_30d} kg`;
                    document.getElementById('predWeightTrend').textContent = trajectory.trend;
                }
            } catch (err) {
                console.error('Prediction load error:', err);
            }
        }

        // Meal Planning Logic
        async function loadMealPlan() {
            const grid = document.getElementById('mealPlanGrid');
            try {
                const response = await fetch('/api/meal-plan/current', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                if (data.has_plan) {
                    renderMealPlan(data.plan);
                    document.getElementById('planDates').textContent = `Active since ${data.start_date}`;
                } else {
                    grid.innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; padding: 60px;">
                            <p style="color: var(--text-muted); margin-bottom: 20px;">No plan generated yet.</p>
                            <button onclick="generateNewPlan()" style="padding: 12px 24px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 700;">‚ú® Generate Weekly Plan</button>
                        </div>
                    `;
                }
            } catch (err) {
                grid.innerHTML = '<p>Error loading plan.</p>';
            }
        }

        async function generateNewPlan() {
            const grid = document.getElementById('mealPlanGrid');
            grid.innerHTML = `
                <div style="grid-column: 1/-1; text-align: center; padding: 60px;">
                    <div style="font-size: 40px; margin-bottom: 20px;">ü§ñ</div>
                    <h3 style="margin-bottom: 12px;">Generating your personalized AI plan...</h3>
                    <p style="color: var(--text-muted); font-size: 14px;">Our AI is analyzing your medical profile and crafting your 7-day schedule.<br><strong>This can take up to 2 minutes.</strong> Please stay on this page.</p>
                </div>
            `;
            try {
                const response = await fetch('/api/meal-plan/generate', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                if (data.status === 'success') {
                    renderMealPlan(data.plan);
                } else {
                    alert('Generation failed: ' + (data.detail || 'Internal error'));
                    loadMealPlan();
                }
            } catch (err) {
                alert('Connection error');
                loadMealPlan();
            }
        }

        function renderMealPlan(planData) {
            const grid = document.getElementById('mealPlanGrid');
            const weekly = planData.weekly_plan || {};

            let html = '';
            // Sorting keys Day 1, Day 2 etc
            const days = Object.keys(weekly).sort((a, b) => {
                const numA = parseInt(a.replace('Day ', ''));
                const numB = parseInt(b.replace('Day ', ''));
                return numA - numB;
            });

            days.forEach(day => {
                const dayData = weekly[day];
                html += `
                    <div class="day-column">
                        <div class="day-header">${day}</div>
                        ${renderMealSlot('Breakfast', dayData.Breakfast)}
                        ${renderMealSlot('Lunch', dayData.Lunch)}
                        ${renderMealSlot('Dinner', dayData.Dinner)}
                    </div>
                `;
            });
            grid.innerHTML = html;
        }

        function renderMealSlot(type, meal) {
            if (!meal) return '';
            return `
                <div class="meal-slot">
                    <div class="meal-slot-title">${type}</div>
                    <div class="meal-slot-name">${meal.name}</div>
                    <div class="meal-slot-cals">${meal.calories} kcal</div>
                </div>
            `;
        }

        // Grocery List Modal
        async function showGroceryList() {
            document.getElementById('groceryModal').style.display = 'flex';
            const content = document.getElementById('groceryListContent');
            content.innerHTML = '<p>Preparing your list...</p>';

            try {
                const response = await fetch('/api/grocery-list', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                if (data.status === 'success') {
                    if (!data.grocery_list || data.grocery_list.length === 0) {
                        content.innerHTML = '<p style="text-align: center; padding: 20px;">Your grocery list is empty. Try generating a meal plan first!</p>';
                        return;
                    }
                    let html = '';
                    data.grocery_list.forEach(cat => {
                        html += `
                            <div class="grocery-cat">
                                <div class="grocery-cat-title">${cat.category}</div>
                                <div class="grocery-list-items">
                                    ${cat.items.map(i => `
                                        <label class="grocery-item">
                                            <input type="checkbox"> ${i}
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    });
                    content.innerHTML = html;
                } else {
                    content.innerHTML = `<p style="padding: 20px; text-align: center; color: var(--danger);">Error: ${data.detail || data.message || 'Could not load grocery list'}</p>`;
                }
            } catch (err) {
                content.innerHTML = '<p>Error fetching list.</p>';
            }
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', () => {
            initWaterReminders();
            loadProfile();
            loadPredictions();

            // Handle URL tab parameters
            const params = new URLSearchParams(window.location.search);
            const tab = params.get('tab');
            if (tab === 'meal-plan') {
                switchTab('meal-plan');
            }
        });
    </script>
</body>

</html>